name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
  push:
    branches: [ develop ]

env:
  AWS_REGION: ap-southeast-1
  STACK_NAME_STAGING: perplexica-staging
  STACK_NAME_PRODUCTION: perplexica-prod

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if CloudFormation stack exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME_STAGING }} --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy CloudFormation stack
        run: |
          if [ "${{ steps.check-stack.outputs.exists }}" == "true" ]; then
            echo "Updating existing stack..."
            aws cloudformation update-stack \
              --stack-name ${{ env.STACK_NAME_STAGING }} \
              --template-body file://cloudformation-templates/perplexica-ec2-stack.yaml \
              --parameters \
                ParameterKey=KeyName,UsePreviousValue=true \
                ParameterKey=InstanceType,ParameterValue=t3.small \
                ParameterKey=VolumeSize,ParameterValue=20 \
                ParameterKey=SSHLocation,ParameterValue=0.0.0.0/0 \
                ParameterKey=AllocateElasticIP,ParameterValue=true \
                ParameterKey=DomainName,ParameterValue=staging.perplexica.trangvang.ai \
                ParameterKey=EmailAddress,ParameterValue=admin@trangvang.ai \
              --region ${{ env.AWS_REGION }} \
              --capabilities CAPABILITY_IAM
          else
            echo "Creating new stack..."
            aws cloudformation create-stack \
              --stack-name ${{ env.STACK_NAME_STAGING }} \
              --template-body file://cloudformation-templates/perplexica-ec2-stack.yaml \
              --parameters \
                ParameterKey=KeyName,ParameterValue=perplexica-key \
                ParameterKey=InstanceType,ParameterValue=t3.small \
                ParameterKey=VolumeSize,ParameterValue=20 \
                ParameterKey=SSHLocation,ParameterValue=0.0.0.0/0 \
                ParameterKey=AllocateElasticIP,ParameterValue=true \
                ParameterKey=DomainName,ParameterValue=staging.perplexica.trangvang.ai \
                ParameterKey=EmailAddress,ParameterValue=admin@trangvang.ai \
              --region ${{ env.AWS_REGION }} \
              --capabilities CAPABILITY_IAM
          fi

      - name: Wait for stack completion
        run: |
          if [ "${{ steps.check-stack.outputs.exists }}" == "true" ]; then
            aws cloudformation wait stack-update-complete \
              --stack-name ${{ env.STACK_NAME_STAGING }} \
              --region ${{ env.AWS_REGION }}
          else
            aws cloudformation wait stack-create-complete \
              --stack-name ${{ env.STACK_NAME_STAGING }} \
              --region ${{ env.AWS_REGION }}
          fi

      - name: Get stack outputs
        id: stack-outputs
        run: |
          PUBLIC_IP=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME_STAGING }} \
            --query 'Stacks[0].Outputs[?OutputKey==`PublicIP`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          echo "public-ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "application-url=https://staging.perplexica.trangvang.ai" >> $GITHUB_OUTPUT

      - name: Update config.toml on staging
        run: |
          PUBLIC_IP=${{ steps.stack-outputs.outputs.public-ip }}
          
          # Create staging config.toml
          cat > staging-config.toml << 'EOF'
          [GENERAL]
          SIMILARITY_MEASURE = "cosine"
          KEEP_ALIVE = "5m"

          [MODELS.GROQ]
          API_KEY = "${{ secrets.GROQ_API_KEY }}"

          [MODELS.GEMINI]
          API_KEY = "${{ secrets.GEMINI_API_KEY }}"

          [MODELS.CUSTOM_OPENAI]
          API_KEY = "${{ secrets.CUSTOM_OPENAI_API_KEY }}"
          API_URL = "https://api.z.ai/api/coding/paas/v4"
          MODEL_NAME = "glm-4.5"

          [API_ENDPOINTS]
          SEARXNG = "https://searchweb.trangvang.ai"
          EOF

          # Copy config to staging instance
          scp -i ~/.ssh/perplexica-key.pem -o StrictHostKeyChecking=no \
            staging-config.toml ubuntu@$PUBLIC_IP:/opt/Perplexica/config.toml

      - name: Restart staging service
        run: |
          PUBLIC_IP=${{ steps.stack-outputs.outputs.public-ip }}
          
          ssh -i ~/.ssh/perplexica-key.pem -o StrictHostKeyChecking=no ubuntu@$PUBLIC_IP \
            "sudo systemctl restart perplexica && sleep 10 && sudo systemctl status perplexica"

      - name: Health check staging
        run: |
          PUBLIC_IP=${{ steps.stack-outputs.outputs.public-ip }}
          
          # Wait for service to be ready
          for i in {1..30}; do
            if curl -f -s "https://staging.perplexica.trangvang.ai/api/config" > /dev/null; then
              echo "✅ Staging health check passed"
              break
            fi
            echo "⏳ Waiting for staging to be ready... ($i/30)"
            sleep 10
          done

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            🚀 Staging deployment successful!
            URL: ${{ steps.stack-outputs.outputs.application-url }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-production:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if CloudFormation stack exists
        id: check-stack-prod
        run: |
          if aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME_PRODUCTION }} --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy CloudFormation stack
        run: |
          if [ "${{ steps.check-stack-prod.outputs.exists }}" == "true" ]; then
            echo "Updating existing production stack..."
            aws cloudformation update-stack \
              --stack-name ${{ env.STACK_NAME_PRODUCTION }} \
              --template-body file://cloudformation-templates/perplexica-ec2-stack.yaml \
              --parameters \
                ParameterKey=KeyName,UsePreviousValue=true \
                ParameterKey=InstanceType,ParameterValue=t3.small \
                ParameterKey=VolumeSize,ParameterValue=30 \
                ParameterKey=SSHLocation,ParameterValue=0.0.0.0/0 \
                ParameterKey=AllocateElasticIP,ParameterValue=true \
                ParameterKey=DomainName,ParameterValue=perplexica.trangvang.ai \
                ParameterKey=EmailAddress,ParameterValue=admin@trangvang.ai \
              --region ${{ env.AWS_REGION }} \
              --capabilities CAPABILITY_IAM
          else
            echo "Creating new production stack..."
            aws cloudformation create-stack \
              --stack-name ${{ env.STACK_NAME_PRODUCTION }} \
              --template-body file://cloudformation-templates/perplexica-ec2-stack.yaml \
              --parameters \
                ParameterKey=KeyName,ParameterValue=perplexica-key \
                ParameterKey=InstanceType,ParameterValue=t3.small \
                ParameterKey=VolumeSize,ParameterValue=30 \
                ParameterKey=SSHLocation,ParameterValue=0.0.0.0/0 \
                ParameterKey=AllocateElasticIP,ParameterValue=true \
                ParameterKey=DomainName,ParameterValue=perplexica.trangvang.ai \
                ParameterKey=EmailAddress,ParameterValue=admin@trangvang.ai \
              --region ${{ env.AWS_REGION }} \
              --capabilities CAPABILITY_IAM
          fi

      - name: Wait for stack completion
        run: |
          if [ "${{ steps.check-stack-prod.outputs.exists }}" == "true" ]; then
            aws cloudformation wait stack-update-complete \
              --stack-name ${{ env.STACK_NAME_PRODUCTION }} \
              --region ${{ env.AWS_REGION }}
          else
            aws cloudformation wait stack-create-complete \
              --stack-name ${{ env.STACK_NAME_PRODUCTION }} \
              --region ${{ env.AWS_REGION }}
          fi

      - name: Get stack outputs
        id: stack-outputs-prod
        run: |
          PUBLIC_IP=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME_PRODUCTION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`PublicIP`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          echo "public-ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "application-url=https://perplexica.trangvang.ai" >> $GITHUB_OUTPUT

      - name: Update config.toml on production
        run: |
          PUBLIC_IP=${{ steps.stack-outputs-prod.outputs.public-ip }}
          
          # Create production config.toml
          cat > production-config.toml << 'EOF'
          [GENERAL]
          SIMILARITY_MEASURE = "cosine"
          KEEP_ALIVE = "5m"

          [MODELS.GROQ]
          API_KEY = "${{ secrets.GROQ_API_KEY }}"

          [MODELS.GEMINI]
          API_KEY = "${{ secrets.GEMINI_API_KEY }}"

          [MODELS.CUSTOM_OPENAI]
          API_KEY = "${{ secrets.CUSTOM_OPENAI_API_KEY }}"
          API_URL = "https://api.z.ai/api/coding/paas/v4"
          MODEL_NAME = "glm-4.5"

          [API_ENDPOINTS]
          SEARXNG = "https://searchweb.trangvang.ai"
          EOF

          # Copy config to production instance
          scp -i ~/.ssh/perplexica-key.pem -o StrictHostKeyChecking=no \
            production-config.toml ubuntu@$PUBLIC_IP:/opt/Perplexica/config.toml

      - name: Restart production service
        run: |
          PUBLIC_IP=${{ steps.stack-outputs-prod.outputs.public-ip }}
          
          ssh -i ~/.ssh/perplexica-key.pem -o StrictHostKeyChecking=no ubuntu@$PUBLIC_IP \
            "sudo systemctl restart perplexica && sleep 10 && sudo systemctl status perplexica"

      - name: Health check production
        run: |
          PUBLIC_IP=${{ steps.stack-outputs-prod.outputs.public-ip }}
          
          # Wait for service to be ready
          for i in {1..30}; do
            if curl -f -s "https://perplexica.trangvang.ai/api/config" > /dev/null; then
              echo "✅ Production health check passed"
              break
            fi
            echo "⏳ Waiting for production to be ready... ($i/30)"
            sleep 10
          done

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            🚀 Production deployment successful!
            URL: ${{ steps.stack-outputs-prod.outputs.application-url }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
